---
import Layout from '../../layouts/Layout.astro';
import ServicioCarrusel from '../../components/ServicioCarrusel';

export const prerender = false;

const { id } = Astro.params;
const backendUrl = import.meta.env.PUBLIC_BACKEND_URL;

let servicio = null;
let errorMessage = null;

// Protección si el id no es válido
if (!id || typeof id !== "string" || id.length < 10) {
  errorMessage = 'ID de servicio inválido.';
} else {
  try {
    const response = await fetch(`${backendUrl}/api/servicio/${id}`);
    if (!response.ok) {
      if (response.status === 404) {
        throw new Error('Servicio no encontrado.');
      } else {
        throw new Error(`Error al cargar el servicio: ${response.statusText}`);
      }
    }
    servicio = await response.json();
  } catch (error) {
    errorMessage = error.message;
  }
}

// Función para links de compartir
function getShareUrl(red, servicio) {
  const url = encodeURIComponent(`${Astro.site ? Astro.site.origin : ''}/servicio/${servicio._id}`);
  const title = encodeURIComponent(servicio.oficio ? `${servicio.oficio} en ${servicio.pueblo} - EnMiPueblo` : 'Servicio en EnMiPueblo');
  const text = encodeURIComponent(servicio.descripcion || '');

  switch (red) {
    case 'facebook':
      return `https://www.facebook.com/sharer/sharer.php?u=${url}`;
    case 'x':
      return `https://twitter.com/intent/tweet?url=${url}&text=${title}`;
    case 'linkedin':
      return `https://www.linkedin.com/sharing/share-offsite/?url=${url}`;
    case 'whatsapp':
      return `https://wa.me/?text=${title}%20${url}`;
    default:
      return '#';
  }
}

// Íconos redes (usar svg como string, NO como jsx)
const redes = [
  {
    id: 'facebook',
    label: 'Facebook',
    svg: `<svg viewBox="0 0 24 24" class="w-7 h-7" fill="none"><path d="M22 12c0-5.522-4.477-10-10-10S2 6.478 2 12c0 4.991 3.657 9.128 8.438 9.877v-6.987h-2.54v-2.89h2.54V9.845c0-2.506 1.493-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.462h-1.261c-1.243 0-1.631.772-1.631 1.562v1.879h2.773l-.443 2.89h-2.33V21.88C18.343 21.128 22 16.991 22 12z" fill="#29916E"/></svg>`,
  },
  {
    id: 'x',
    label: 'X',
    svg: `<svg viewBox="0 0 24 24" class="w-7 h-7" fill="none"><path d="M5.5 5.5L18.5 18.5M18.5 5.5L5.5 18.5" stroke="#89908F" stroke-width="2" stroke-linecap="round"/></svg>`,
  },
  {
    id: 'linkedin',
    label: 'LinkedIn',
    svg: `<svg viewBox="0 0 24 24" class="w-7 h-7" fill="none"><rect x="2" y="2" width="20" height="20" rx="5" fill="#29916E" /><path d="M6 9h2v8H6zM7 7.5a1 1 0 110-2 1 1 0 010 2zM10 11h2v1.08c.58-.77 1.48-1.26 2.46-1.08C16.06 11.21 17 12.27 17 14v3h-2v-2.6c0-.81-.52-1.29-1.17-1.29-.61 0-1.13.48-1.13 1.29V17h-2z" fill="#fff"/></svg>`,
  },
  {
    id: 'whatsapp',
    label: 'WhatsApp',
    svg: `<svg viewBox="0 0 24 24" class="w-7 h-7" fill="none"><circle cx="12" cy="12" r="10" fill="#29916E" /><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.472-.148-.67.149-.198.297-.767.967-.94 1.164-.173.198-.347.223-.644.074-.297-.149-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.654-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.52.149-.173.198-.297.298-.495.099-.198.05-.372-.025-.52-.075-.149-.67-1.611-.916-2.205-.242-.583-.487-.504-.67-.513-.173-.008-.372-.01-.57-.01-.198 0-.52.074-.792.372-.273.297-1.04 1.016-1.04 2.479 0 1.463 1.065 2.876 1.213 3.074.149.198 2.097 3.212 5.086 4.375.711.305 1.263.487 1.695.624.713.228 1.361.196 1.873.119.572-.086 1.758-.719 2.007-1.412.248-.693.248-1.287.173-1.412-.075-.124-.272-.198-.57-.347z" fill="#fff"/></svg>`,
  },
];
---

<Layout title={servicio ? `Servicio: ${servicio.nombre}` : 'Servicio no encontrado'}>
  <section class="min-h-[90vh] flex items-center justify-center bg-gradient-to-br from-green-50 via-white to-emerald-50 py-10 px-2">
    <div class="w-full max-w-3xl bg-white rounded-3xl shadow-2xl border border-green-100 overflow-hidden">
      {errorMessage ? (
        <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6 rounded-lg shadow-md">
          <p class="font-bold">Error:</p>
          <p>{errorMessage}</p>
          <a href="/buscar" class="mt-2 inline-block text-red-800 hover:underline">Volver a la búsqueda</a>
        </div>
      ) : servicio && (
        <>
          <div class="rounded-t-3xl overflow-hidden shadow-none md:shadow-lg">
            <ServicioCarrusel
              client:load
              imagenes={servicio.imagenes ?? []}
              videoUrl={servicio.videoUrl ?? ''}
            />
          </div>

          <div class="p-4 md:p-8 pt-6 md:pt-10">
            {/* CHIP/ICONOS Y FECHA */}
            <div class="flex flex-wrap items-center gap-3 mb-4">
              <span class="inline-flex items-center gap-1 bg-emerald-100 text-emerald-700 font-semibold rounded-full px-4 py-1 text-xs md:text-sm shadow">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 20 20"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m4 4V3m-9 4h14M5 11h10m-9 4h8"/></svg>
                {servicio.categoria}
              </span>
              <span class="inline-flex items-center gap-1 bg-gray-100 text-gray-700 font-medium rounded-full px-3 py-1 text-xs md:text-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 20 20"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c0-1.105-.895-2-2-2s-2 .895-2 2 .895 2 2 2zm0 4h-4a2 2 0 100 4h4a2 2 0 100-4z"/></svg>
                {servicio.pueblo}
              </span>
              <span class="ml-auto text-xs text-gray-400">
                {servicio.creado ? new Date(servicio.creado).toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' }) : ''}
              </span>
            </div>

            {/* TITULO Y OFICIO */}
            <h1 class="text-3xl md:text-5xl font-black text-emerald-700 mb-1 tracking-tight leading-tight">{servicio.nombre}</h1>
            <p class="text-lg md:text-2xl font-semibold text-emerald-600 mb-6 flex items-center gap-2">
              <svg class="w-6 h-6 text-emerald-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M8 7V3m4 4V3m-9 4h14M5 11h10m-9 4h8" stroke-linecap="round" stroke-linejoin="round"/></svg>
              {servicio.oficio}
            </p>

            {/* DESCRIPCIÓN */}
            <div class="bg-emerald-50 rounded-xl p-5 md:p-6 mb-6 shadow-inner border border-emerald-100">
              <h2 class="text-xl font-bold text-emerald-700 mb-2 flex items-center gap-2">
                <svg class="w-5 h-5 text-emerald-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h6a2 2 0 012 2v6a2 2 0 002 2h6a2 2 0 01-2 2v6a2 2 0 01-2 2z"/></svg>
                Descripción del servicio
              </h2>
              <p class="text-gray-800 text-base md:text-lg leading-relaxed whitespace-pre-wrap">
                {servicio.descripcion}
              </p>
            </div>

            {/* CONTACTO + TELÉFONO + COMPARTIR */}
            <div class="mt-2 grid gap-4 md:gap-8 grid-cols-1 md:grid-cols-2">
              {/* COLUMNA 1: CONTACTO */}
              <div class="flex flex-col gap-3 bg-white rounded-xl border border-gray-100 shadow p-5">
                <span class="text-lg font-bold text-emerald-800 mb-1">Contacto</span>
                {servicio.contacto && (
                  <div class="flex items-center gap-2">
                    <svg class="w-5 h-5 text-emerald-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" /><path d="M12 16v-4m0-4h.01" /></svg>
                    <span class="font-semibold">Teléfono:</span>
                    <a href={`tel:${servicio.contacto.replace(/[^0-9+]/g, '')}`} class="text-emerald-700 underline hover:text-emerald-900 ml-1 flex items-center gap-1">
                      {servicio.contacto}
                      <svg class="w-5 h-5 text-emerald-600 ml-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M22 16.92V21a1 1 0 0 1-1.09 1A19.91 19.91 0 0 1 3 5.09 1 1 0 0 1 4 4h4.09a1 1 0 0 1 1 .75l1.12 4.45a1 1 0 0 1-.27 1L8.21 12.21a16 16 0 0 0 6.6 6.6l2-2a1 1 0 0 1 1-.27l4.45 1.12A1 1 0 0 1 22 16.92z" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    </a>
                  </div>
                )}
                <div class="flex items-center gap-2">
                  <svg class="w-5 h-5 text-emerald-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M16 8a6 6 0 00-12 0v5a6 6 0 0012 0V8z"/><circle cx="12" cy="12" r="10" /></svg>
                  <span class="font-semibold">Email:</span>
                  <span class="text-emerald-700 font-mono break-all">{servicio.usuarioEmail || '-'}</span>
                </div>
                {servicio.whatsapp && (
                  <a
                    href={`https://wa.me/${servicio.whatsapp.replace(/[^0-9]/g, '')}?text=Hola%2C+vi+tu+anuncio+en+EnMiPueblo`}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="flex items-center gap-2 bg-green-100 text-green-800 hover:bg-green-200 transition rounded-xl px-4 py-2 font-bold mt-2 shadow"
                  >
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M20.52 3.482A12.053 12.053 0 0 0 12.005 0C5.381 0 .004 5.378.004 12.001c0 2.119.551 4.188 1.595 6.017L.057 23.944l6.08-1.586a11.935 11.935 0 0 0 5.868 1.496h.002c6.624 0 12.002-5.379 12.002-12.003a12.02 12.02 0 0 0-3.489-8.421zm-8.515 18.407a9.952 9.952 0 0 1-5.066-1.388l-.364-.217-3.607.942.963-3.519-.236-.373A9.987 9.987 0 0 1 2.02 12.001c0-5.516 4.486-10.001 9.985-10.001 2.666 0 5.175 1.038 7.062 2.925a9.951 9.951 0 0 1 2.926 7.076c0 5.515-4.487 10.001-9.985 10.001zm5.487-7.477c-.301-.15-1.773-.876-2.047-.976-.273-.099-.473-.15-.672.15-.2.3-.773.975-.949 1.175-.174.2-.348.225-.649.075-.301-.15-1.273-.469-2.425-1.497-.897-.797-1.504-1.781-1.681-2.081-.175-.3-.019-.462.132-.612.136-.135.301-.349.451-.523.151-.175.2-.3.301-.5.1-.2.05-.375-.025-.524-.075-.15-.673-1.625-.923-2.224-.243-.583-.491-.504-.673-.513l-.575-.01c-.2 0-.524.075-.799.375s-1.048 1.024-1.048 2.5c0 1.475 1.073 2.899 1.222 3.099.151.2 2.114 3.225 5.125 4.398.717.309 1.277.494 1.715.633.72.229 1.376.197 1.892.12.577-.086 1.773-.724 2.023-1.426.25-.701.25-1.302.175-1.426-.075-.124-.274-.199-.574-.349z"/></svg>
                    WhatsApp
                  </a>
                )}
              </div>
              {/* COLUMNA 2: COMPARTIR */}
              <div class="flex flex-col gap-4 justify-between bg-white rounded-xl border border-gray-100 shadow p-5">
                <span class="text-lg font-bold text-emerald-800 mb-1">¿Quieres contactar?</span>
                <p class="text-sm text-gray-600 mb-4">Teléfono, WhatsApp o email para contactar.<br/>O comparte este servicio:</p>
                <div class="flex gap-3 items-center justify-center mt-2">
                  {redes.map(r => (
                    <a
                      href={getShareUrl(r.id, servicio)}
                      target="_blank"
                      rel="noopener"
                      class="flex items-center gap-1 px-2 py-1 rounded-lg hover:bg-emerald-50 text-emerald-800 hover:text-emerald-900 transition"
                      aria-label={`Compartir en ${r.label}`}
                      tabIndex={0}
                      set:html={r.svg}
                    ></a>
                  ))}
                </div>
              </div>
            </div>

            {/* Volver */}
            <div class="flex justify-center mt-8">
              <a href="/buscar" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-3 px-8 rounded-2xl transition duration-300 shadow-md text-lg">
                ← Volver a Buscar Servicios
              </a>
            </div>
          </div>
        </>
      )}
    </div>
  </section>
    <!-- Bloque de Anuncios de Google (al final) -->
  <div class="flex justify-center mt-10">
    <div class="max-w-3xl w-full px-4">
      <ins class="adsbygoogle"
        style="display:block"
        data-ad-client="ca-pub-xxxxxxxxxxxxxxxx"
        data-ad-slot="xxxxxxxxxx"
        data-ad-format="auto"
        data-full-width-responsive="true"></ins>
      <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
    </div>
  </div>
</Layout>
