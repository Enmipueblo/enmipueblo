---
// src/components/Header.astro
import AuthIsland from "./AuthIsland.tsx";
---

<script is:inline>
  (function () {
    if (window.__enmiHeaderInit) return;
    window.__enmiHeaderInit = true;

    function getCookie(name) {
      try {
        const v = document.cookie.match("(^|;)\\s*" + name + "\\s*=\\s*([^;]+)");
        return v ? decodeURIComponent(v.pop()) : "";
      } catch { return ""; }
    }

    function isLogged() {
      if (getCookie("userEmail")) return true;
      return !!(window.__enmiPuebloUser__ && window.__enmiPuebloUser__?.email);
    }

    function updateSidebarAuthButton() {
      const btn = document.getElementById("mobile-auth-btn");
      if (!btn) return;

      if (isLogged()) {
        btn.textContent = "Mi panel";
        btn.onclick = () => { window.location.href = "/usuario/panel"; };
      } else {
        btn.textContent = "Iniciar sesión";
        btn.onclick = () => { window.showAuthModal && window.showAuthModal(); };
      }
    }

    let menuOpen = false;

    function updateMenu() {
      const sidebar = document.getElementById("mobile-sidebar");
      const overlay = document.getElementById("mobile-overlay");
      if (!sidebar || !overlay) return;

      if (menuOpen) {
        sidebar.classList.remove("translate-x-[-110%]");
        sidebar.classList.add("translate-x-0");
        overlay.classList.remove("hidden");
        updateSidebarAuthButton();
        document.documentElement.classList.add("overflow-hidden");
      } else {
        sidebar.classList.remove("translate-x-0");
        sidebar.classList.add("translate-x-[-110%]");
        overlay.classList.add("hidden");
        document.documentElement.classList.remove("overflow-hidden");
      }
    }

    window.openMenu = () => { menuOpen = true; updateMenu(); };
    window.closeMenu = () => { menuOpen = false; updateMenu(); };

    window.addEventListener("resize", () => {
      if (menuOpen && window.innerWidth >= 1024) {
        window.closeMenu();
      }
    });

    document.addEventListener("DOMContentLoaded", updateSidebarAuthButton);
  })();
</script>

<header class="sticky top-0 z-50">
  <div
    class="border-b shadow-[0_12px_30px_-24px_rgba(0,0,0,0.35)]"
    style="
      background: linear-gradient(to bottom, rgba(207,239,255,0.72) 0%, rgba(255,255,255,0.52) 100%);
      backdrop-filter: blur(10px);
      border-color: var(--sb-border);
    "
  >
    <div class="mx-auto max-w-6xl px-4 py-3 flex items-center justify-between gap-3 min-h-[56px]">
      <a
        href="/"
        class="shrink-0 text-lg sm:text-xl md:text-2xl font-extrabold tracking-tight transition"
        aria-label="Inicio EnMiPueblo"
        style="color: var(--sb-ink);"
      >
        EnMiPueblo<span style="color: var(--sb-accent);">.</span>
      </a>

      <nav class="hidden lg:flex items-center gap-6 text-base font-semibold">
        <a href="/buscar" class="transition hover:opacity-90" style="color: var(--sb-ink);">Buscar</a>
        <a href="/ofrecer" class="transition hover:opacity-90" style="color: var(--sb-ink);">Ofrecer</a>
        <a href="/contacto" class="transition hover:opacity-90" style="color: var(--sb-ink);">Contacto</a>
      </nav>

      <div class="flex items-center gap-2 min-w-0">
        <AuthIsland client:only="react" className="hidden md:flex" />

        <button
          id="mobile-menu-btn"
          class="lg:hidden ml-1 p-2 rounded-xl border bg-white/80 hover:bg-white transition shadow-sm"
          style="border-color: var(--sb-border);"
          aria-label="Abrir menú"
          type="button"
          onclick="window.openMenu && window.openMenu()"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2.3" viewBox="0 0 24 24" style="color: var(--sb-ink);">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 7h16M4 12h16M4 17h16"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <div
    id="mobile-overlay"
    class="hidden fixed inset-0 z-[998] lg:hidden"
    style="background: rgba(0,0,0,0.72);"
    onclick="window.closeMenu && window.closeMenu()"
    aria-hidden="true"
  />

  <div
    id="mobile-sidebar"
    class="fixed top-0 left-0 w-full h-full z-[999]
           transition-transform duration-300 transform-gpu translate-x-[-110%] lg:hidden
           overflow-y-auto px-6 py-8"
    style="
      will-change: transform;
      background:
        radial-gradient(900px circle at 22% 18%, rgba(255,255,255,0.55) 0%, rgba(0,0,0,0) 62%),
        radial-gradient(900px circle at 82% 22%, rgba(90,208,230,0.28) 0%, rgba(0,0,0,0) 60%),
        linear-gradient(135deg, #0A7F4F 0%, #13A7A8 44%, #5AD0E6 100%);
      color: #F6FFFD;
    "
  >
    <div class="flex items-start justify-between gap-4">
      <div>
        <div class="text-sm font-semibold" style="color: rgba(246,255,253,0.85);">Menú</div>
        <div class="mt-1 text-2xl font-extrabold tracking-tight" style="color: #F6FFFD;">
          EnMiPueblo<span style="color: rgba(207,239,255,0.95);">.</span>
        </div>
      </div>

      <button
        class="shrink-0 w-11 h-11 rounded-full border bg-white/90 hover:bg-white transition shadow-sm flex items-center justify-center"
        style="border-color: rgba(255,255,255,0.45);"
        aria-label="Cerrar menú"
        onclick="window.closeMenu && window.closeMenu()"
        type="button"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="color: var(--sb-ink);">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <div class="mt-4 h-px" style="background: rgba(255,255,255,0.22);"></div>

    <nav class="mt-6 flex flex-col gap-3 font-extrabold text-lg">
      <a href="/buscar"
         class="rounded-2xl px-4 py-3 border hover:bg-white transition shadow-sm"
         style="background: rgba(255,255,255,0.90); color: var(--sb-ink); border-color: rgba(255,255,255,0.45);"
         onclick="window.closeMenu && window.closeMenu()">Buscar</a>

      <a href="/ofrecer"
         class="rounded-2xl px-4 py-3 border hover:bg-white transition shadow-sm"
         style="background: rgba(255,255,255,0.90); color: var(--sb-ink); border-color: rgba(255,255,255,0.45);"
         onclick="window.closeMenu && window.closeMenu()">Ofrecer</a>

      <a href="/contacto"
         class="rounded-2xl px-4 py-3 border hover:bg-white transition shadow-sm"
         style="background: rgba(255,255,255,0.90); color: var(--sb-ink); border-color: rgba(255,255,255,0.45);"
         onclick="window.closeMenu && window.closeMenu()">Contacto</a>
    </nav>

    <div class="mt-8 pt-6 border-t" style="border-color: rgba(255,255,255,0.22);">
      <div class="text-sm font-semibold mb-3" style="color: rgba(246,255,253,0.86);">Cuenta</div>

      <button
        id="mobile-auth-btn"
        class="w-full px-4 py-3 rounded-2xl font-extrabold text-base transition shadow-sm border"
        style="background: #0B2A3D; color: #F6FFFD; border-color: rgba(255,255,255,0.22);"
        type="button"
      >
        Iniciar sesión
      </button>

      <div class="text-sm mt-3 leading-snug" style="color: rgba(246,255,253,0.78);">
        Si ya estás dentro, aquí verás el acceso a tu panel.
      </div>
    </div>
  </div>
</header>
